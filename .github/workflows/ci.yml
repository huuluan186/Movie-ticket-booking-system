name: CI â€“ Build & Smokeâ€‘test Docker stack

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-smoke-test:
    runs-on: ubuntu-latest

    steps:
      # 1) Láº¥y mÃ£ nguá»“n
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      # 2) Thiáº¿t láº­p Docker Buildx (Ä‘á»ƒ build multiâ€‘stage)
      - name: âš™ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3) Táº¡o file .env táº¡m (náº¿u repo Ä‘Ã£ cÃ³ .env rá»“i thÃ¬ cÃ³ thá»ƒ bá» bÆ°á»›c nÃ y)
      - name: ğŸ“„ Create .env for CI
        run: |
          cat <<EOF > .env
          MYSQL_DATABASE=cinemadb
          MYSQL_ROOT_PASSWORD=root
          NODE_ENV=test
          PORT=5000
          CLIENT_PORT=3000
          DB_NAME=cinemadb
          DB_USER=root
          DB_PASSWORD=root
          DB_HOST=db
          DB_PORT=3306
          DB_DIALECT=mysql
          CLIENT_URL=http://localhost:3000
          SECRET_KEY=test_secret
          REACT_APP_SERVER_URL=http://localhost:5000
          EOF
      
      # ğŸ§© CÃ i docker-compose (do GitHub runner khÃ´ng cÃ³ sáºµn)
      - name: ğŸ§© Install docker-compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" \
            -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      # 4) Build toÃ n bá»™ image
      - name: ğŸ³ dockerâ€‘compose build
        run: docker-compose build

      # 5) Cháº¡y stack
      - name: ğŸš€ dockerâ€‘compose up (detached)
        run: docker-compose up -d

      # 6) Äá»£i server lÃªn & ping endpoint
      - name: â³ Wait & healthâ€‘check
        run: |
          echo "â³ Waiting for server..."
          for i in {1..15}; do
            if curl -fs http://localhost:5000/api-docs > /dev/null; then
              echo "âœ… Server responded OK"; exit 0
            fi
            echo "âŒ› Still waiting ($i/15)"; sleep 5
          done
          echo "âŒ Server not ready in time"; docker-compose logs; exit 1

      # 7) Dá»n dáº¹p
      - name: ğŸ§¹ Clean up
        if: always()
        run: docker-compose down -v
